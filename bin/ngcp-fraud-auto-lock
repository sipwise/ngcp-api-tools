#!/usr/bin/perl

use strict;
use warnings;

use Email::Sender::Simple qw(sendmail);
use Sipwise::Provisioning::Billing;

my %LOCK = (
	none => undef,
	foreign => 1,
	outgoing => 2,
	incoming => 3,
	global => 4,
	0 => 'none',
	1 => 'foreign',
	2 => 'outgoing',
	3 => 'incoming',
	4 => 'global',
); 

my $conf = Sipwise::Provisioning::Config->new()->get_config();

my $o = Sipwise::Provisioning::Billing->new();
my $db = $o->{database};

my $a = $db->sql_get_all_arrayref(<<"!");
	SELECT c.id, p.fraud_interval_lock, p.fraud_interval_notify,
               b.cash_balance_interval, p.fraud_interval_limit
          FROM contracts c, billing_profiles p, contract_balances b
         WHERE p.id = (SELECT m.billing_profile_id
                         FROM billing_mappings m
                        WHERE (   m.start_date IS NULL
                               OR m.start_date <= now())
                          AND (   m.end_date IS NULL
                               OR m.end_date >= now())
                          AND m.contract_id = c.id
                     ORDER BY m.start_date desc limit 1)
           AND b.contract_id = c.id
           AND b.start <= now()
           AND b.end >= now()
           AND c.status = 'active'
           AND p.fraud_interval_limit > 0
           AND (   p.fraud_interval_lock
                OR p.fraud_interval_notify)
           AND b.cash_balance_interval >= p.fraud_interval_limit
!

for my $e (@$a) {
	$e->{fraud_interval_lock} and
		$o->lock_voip_account({id => $e->{id}, lock => $LOCK{$e->{fraud_interval_lock}}});

	$e->{fraud_interval_notify} or next;

	my $subs = $db->sql_get_all_arrayref(<<"!", $e->{id});
		SELECT s.username, d.domain, s.external_id
                  FROM voip_subscribers s
             LEFT JOIN domains d ON d.id = s.domain_id
                 WHERE s.contract_id = ?
!

	my $cur = sprintf('%.2f', $e->{cash_balance_interval} / 100);
	my $max = sprintf('%.2f', $e->{fraud_interval_limit} / 100);

    my $body;
    if ($e->{fraud_interval_lock}) {
        $body = "Account ID " . $e->{id} . " has been locked due to exceeding the configured" . "\n"
              . "credit balance threshold ($cur >= $max ).\n\n";
    }
    else {
        $body = "Account ID " . $e->{id} . " is currently exceeding the configured credit balance" . "\n"
              . "threshold ($cur >= $max), but has not been locked due to configuration.\n\n";
    }

	if (!$subs || !@$subs) {
		$body .= "There are no affected subscribers.\n";
	}
	else {
		$body .= "Affected subscribers:\n";
		for my $s (@$subs) {
			$body .= "\t$s->{username}\@$s->{domain}".
				($s->{external_id} ? " (external ID '$s->{external_id}')"
				: '') . "\n";
		}
	}

    sendmail ( Email::Simple->create(
        header => [
            To      => $e->{fraud_interval_notify},
            From    => $$conf{adminmail},
            Subject => 'Account ID ' . $e->{id} . 'locked by fraud detection', 
        ],
        body => $body,
    ));
}

1;
